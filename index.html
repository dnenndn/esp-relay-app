<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<title>ESP Relay Pulse Control</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#667eea">
<link rel="apple-touch-icon" href="icon.png">

<script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>

<style>
body{
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: linear-gradient(135deg,#667eea,#764ba2);
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    margin:0;
    -webkit-font-smoothing: antialiased;
}
.container{
    background:white;
    padding:30px;
    border-radius:20px;
    width:90%;
    max-width:420px;
    text-align:center;
    box-shadow:0 20px 50px rgba(0,0,0,0.3);
}
h1{margin-bottom:10px;}
.status{
    margin:20px 0;
    padding:15px;
    border-radius:10px;
    background:#f1f3f4;
    font-weight:bold;
}
button{
    width:100%;
    padding:20px;
    font-size:20px;
    border:none;
    border-radius:12px;
    background:linear-gradient(135deg,#2979FF,#448AFF);
    color:white;
    cursor:pointer;
}
.log{
    margin-top:20px;
    font-size:12px;
    text-align:left;
    max-height:150px;
    overflow:auto;
    background:#f8f9fa;
    padding:10px;
    border-radius:10px;
    font-family:monospace;
}
</style>
</head>

<body>
<div class="container">
    <h1>âš¡ Relay Pulse</h1>
    <div class="status" id="status">Connecting...</div>
    <button onclick="sendPulse()">SEND 1s PULSE</button>
    <div class="log" id="log"></div>
</div>

<script>
const TOPIC_CONTROL = 'marouane/relay/control';
const TOPIC_STATUS  = 'marouane/relay/status';
const BROKER = 'wss://broker.hivemq.com:8884/mqtt';

let client;

function log(msg){
    const el = document.getElementById('log');
    el.innerHTML = "["+new Date().toLocaleTimeString()+"] "+msg+"<br>"+el.innerHTML;
}

function connect(){
    log("Connecting to HiveMQ...");
    client = mqtt.connect(BROKER, {
        clientId: 'web-'+Math.random().toString(16).substr(2,8)
    });

    client.on('connect', ()=>{
        document.getElementById('status').innerText="Connected";
        log("Connected");
        client.subscribe(TOPIC_STATUS);
    });

    client.on('message',(topic,message)=>{
        let msg = message.toString();
        log("Received: "+msg);

        if(msg==="PULSE_ON"){
            document.getElementById('status').innerText="Relay ON (pulsing)";
        }
        if(msg==="PULSE_DONE"){
            document.getElementById('status').innerText="Pulse finished";
        }
    });

    client.on('error',(e)=>{
        document.getElementById('status').innerText="Connection error";
        log("Error: "+e.message);
    });
}

function sendPulse(){
    if(!client || !client.connected){
        log("Not connected");
        return;
    }
    client.publish(TOPIC_CONTROL,"PULSE");
    document.getElementById('status').innerText="Sending pulse...";
    log("PULSE sent");
}

window.onload = connect;
</script>
</body>
</html>
